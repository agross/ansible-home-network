systemd_networkd_enable_resolved: true
systemd_networkd_symlink_resolv_conf: true
systemd_networkd_apply_config: true

systemd_networkd_netdev:
  iobroker:
    - NetDev:
        - Name: iobroker
        - Kind: macvlan

    - MACVLAN:
        - Mode: bridge

systemd_networkd_network:
  enp6s18:
    - Match:
        - Name: "{{ interfaces.lan.device }}"
    - Network:
        - DHCP: false
        - Address: >-
            {{
              (interfaces.lan.ip4.address ~ '/' ~ interfaces.lan.ip4.prefix) |
              ansible.utils.ipaddr('host/prefix')
            }}
        - Address: >-
            {{
              (interfaces.lan.ip6.address ~ '/' ~ interfaces.lan.ip6.prefix) |
              ansible.utils.ipaddr('host/prefix')
            }}
        - DNS: "{{ interfaces.lan.ip4.dns }}"
        - DNS: "{{ interfaces.lan.ip6.dns }}"
        - DNSDefaultRoute: true
        - Domains: "{{ dns.search_domains | join(' ') }}"
        - MulticastDNS: true

        - IPv6LinkLocalAddressGenerationMode: stable-privacy

        - MACVLAN: iobroker

    - Route:
        - Gateway: "{{ network_gateway.ip4 }}"
        - GatewayOnLink: true

  iobroker:
    - Match:
        - Name: iobroker

    - Network:
        - Address: "{{ iobroker_ip4_range | ansible.utils.next_nth_usable(2) }}"
        - LinkLocalAddressing: false
        - IPv6AcceptRA: false
        # - IPForward: true
        - ConfigureWithoutCarrier: true

    - Route:
        - Destination: "{{ iobroker_ip4 }}"
