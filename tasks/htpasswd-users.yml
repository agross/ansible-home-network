- name: Generate htpasswd
  ansible.builtin.set_fact:
    "{{ fact }}": >-
      {%- set output = [] -%}
      {%- for user, passwd in (users | default({})).items() -%}
        {{
          output.append(
            user ~
            ':' ~
            passwd | password_hash('bcrypt', rounds = 5, salt = salt | mandatory)
          )
        }}
      {%- endfor -%}
      {{ output }}

- name: Generate htpasswd as a comma-separated values
  ansible.builtin.set_fact:
    "{{ fact }}_comma_separated": "{{ vars[fact] | join(',') }}"
