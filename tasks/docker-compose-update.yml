# pull undefined -> skip task
# pull == false -> skip task
# pull == true -> policy=missing
# pull is string -> policy=string
- name: Pull docker images
  when: pull is defined and (pull is string or pull | bool)
  community.docker.docker_compose_v2_pull:
    project_src: "{{ directory }}"
    policy: "{{ pull if pull is string else 'missing' }}"
    ignore_buildable: true
  notify: "{{ notify_ | default(omit) }}"

- name: Build docker images
  when: build is defined and build | bool
  ansible.builtin.command:
    chdir: "{{ directory }}"
    argv:
      - docker
      - compose
      - build
      - --pull
  register: docker_compose_build
  # Cached build: exporting layers done
  # Uncached build: exporting layers 1.2s done
  changed_when: >-
    docker_compose_build.stdout_lines | length > 0 and
    not 'exporting layers done' in docker_compose_build.stdout
  notify: "{{ notify_ | default(omit) }}"
