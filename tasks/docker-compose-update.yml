# pull undefined -> skip task
# pull == false -> skip task
# pull == true -> argv_default
# pull is string -> argv_default + [string]
# pull is list -> argv_default + list
- name: Pull docker images
  when: pull is defined and (pull is string or pull is sequence or pull | bool)
  ansible.builtin.command:
    chdir: "{{ directory }}"
    argv: "{{ argv_combined }}"
  vars:
    argv_default:
      - docker
      - compose
      - pull
    argv_optional: >-
      {{
        [pull] if pull is string
        else pull if pull is sequence
        else []
      }}
    argv_combined: "{{ argv_default + argv_optional }}"
  register: docker_compose_pull
  changed_when: "'Pull complete' in docker_compose_pull.stderr"
  notify: "{{ notify_ | default(omit) }}"

- name: Build docker images
  when: build is defined and build | bool
  ansible.builtin.command:
    chdir: "{{ directory }}"
    argv:
      - docker
      - compose
      - build
      - --pull
  register: docker_compose_build
  # Cached build: exporting layers done
  # Uncached build: exporting layers 1.2s done
  changed_when: >-
    docker_compose_build.stdout_lines | length > 0 and
    not 'exporting layers done' in docker_compose_build.stdout
  notify: "{{ notify_ | default(omit) }}"
