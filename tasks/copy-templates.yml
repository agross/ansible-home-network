- name: Create root directory
  ansible.builtin.file:
    path: "{{ target | default(root) }}"
    state: directory
    mode: '755'
  notify: "{{ notify | default(omit) }}"

- name: Create directories
  ansible.builtin.file:
    path: "{{ target | default(root) }}/{{ item.path }}"
    state: directory
    mode: '755'
  when: item.state == 'directory'
  with_community.general.filetree: "{{ directory }}"
  loop_control:
    label: "{{ item.path }}"
  notify: "{{ notify | default(omit) }}"

- name: Copy non-template files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ target | default(root) }}/{{ item.path }}"
    mode: preserve
  when:
    item.state == 'file' and
      (not item.path.endswith('.j2')) and
      (not item.path | basename == '.gitignore')
  with_community.general.filetree: "{{ directory }}"
  loop_control:
    label: "{{ item.path }}"
  notify: "{{ notify | default(omit) }}"

- name: Copy template files
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ target | default(root) }}/{{ item.path | regex_replace('\\.j2$', '') }}"
    mode: preserve
    lstrip_blocks: true
  when:
    item.state == 'file' and
      item.path.endswith('.j2') and
      (not item.path | basename == '.gitignore')
  with_community.general.filetree: "{{ directory }}"
  loop_control:
    label: "{{ item.path }}"
  notify: "{{ notify | default(omit) }}"
