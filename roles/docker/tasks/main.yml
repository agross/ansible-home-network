- name: Install docker
  ansible.builtin.include_role:
    name: geerlingguy.docker
  vars:
    docker_install_compose_plugin: true
    docker_install_compose: false
    docker_users:
      - "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
    # IPv6 support with NAT for containers, so they are not exposed to the
    # internet.
    docker_daemon_options:
      ipv6: true
      fixed-cidr-v6: fd00:c0ff:ee::/48
      experimental: true
      ip6tables: true

- name: Support docker management via ansible
  ansible.builtin.include_role:
    name: geerlingguy.pip
  vars:
    pip_install_packages:
      - name: docker

- name: Gather installed packages
  ansible.builtin.package_facts:

- name: Upgrade libseccomp2 on Raspberry Pi
  when: "'raspberrypi-kernel' in ansible_facts.packages"
  ansible.builtin.import_tasks:
    file: raspi-libseccomp2.yml

- name: Enable memory cgroups on Raspberry Pi
  when: "'raspberrypi-kernel' in ansible_facts.packages"
  ansible.builtin.import_tasks:
    file: raspi-memory-cgroups.yml
