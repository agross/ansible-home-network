- name: Create target directory
  ansible.builtin.file:
    path: "/github-runner/{{ item.key }}"
    state: directory
    owner: 1001
    group: 987
    mode: "755"
  loop: "{{ instances }}"
  loop_control:
    label: "{{ item.key }}"

- name: Download GitHub Runner
  ansible.builtin.get_url:
    url: >-
      https://github.com/actions/runner/releases/download/v{{ github_runner_version }}/actions-runner-linux-x64-{{ github_runner_version }}.tar.gz
    dest: /tmp/github-runner.tar.gz
    owner: 0
    group: 0
    mode: "644"

- name: Extract archive
  ansible.builtin.unarchive:
    src: /tmp/github-runner.tar.gz
    remote_src: true
    dest: "/github-runner/{{ item.key }}"
  loop: "{{ instances }}"
  loop_control:
    label: "{{ item.key }}"

- name: Configure GitHub Runner
  ansible.builtin.command:
    argv:
      - "/github-runner/{{ item.key }}/config.sh"
      - --unattended
      - --name
      - "{{ item.key }}"
      - --url
      - "{{ item.value.url | ansible.builtin.mandatory }}"
      - --replace
      - --token
      - "{{ item.value.token | ansible.builtin.mandatory }}"
  environment:
    RUNNER_ALLOW_RUNASROOT: "true"
  loop: "{{ instances }}"
  loop_control:
    label: "{{ item.key }} url={{ item.value.url }}"
  register: github_runner_config
  changed_when: true
  failed_when: >-
    github_runner_config.rc != 0 and
    'Cannot configure the runner because it is already configured' not in github_runner_config.stderr

- name: Install GitHub Runner service
  ansible.builtin.command:
    argv:
      - ./svc.sh
      - uninstall
    chdir: "/github-runner/{{ item.key }}"
  loop: "{{ instances }}"
  loop_control:
    label: "{{ item.key }} uninstall"
  changed_when: true

- name: Install GitHub Runner service
  ansible.builtin.command:
    argv:
      - ./svc.sh
      - install
      - root
    chdir: "/github-runner/{{ item.key }}"
  loop: "{{ instances }}"
  loop_control:
    label: "{{ item.key }} install"
  changed_when: true

- name: Start GitHub Runner service
  ansible.builtin.command:
    argv:
      - ./svc.sh
      - start
    chdir: "/github-runner/{{ item.key }}"
  loop: "{{ instances }}"
  loop_control:
    label: "{{ item.key }}"
  changed_when: true
