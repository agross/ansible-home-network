volumes:
  iobroker-data:

{% if traefik_host %}
networks:
  web:
    external: true
{% endif %}

services:
  redis:
    image: redis:alpine

    restart: unless-stopped
    environment:
      TZ: Europe/Berlin
    {% if iobroker_support_wake_on_lan | default(false) | bool %}
    ports:
      - "127.0.0.1:6379:6379"
    {% endif %}
    command: /usr/local/etc/redis/redis.conf
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./redis/data:/data
    healthcheck:
      test: redis-cli ping | grep -xq PONG
      start_period: 5s
      interval: 5s
    sysctls:
      net.core.somaxconn: 512

  app:
    image: {{ iobroker_image }}
    pull_policy: never
    build:
      context: ./iobroker/docker

    restart: unless-stopped
    env_file: ./iobroker/.env
    hostname: iobroker
    labels:
      traefik.enable: 'true'
      traefik.http.routers.iobroker.entrypoints: https
      traefik.http.routers.iobroker.rule: Host(`iobroker.{{ network.domain }}`)
      traefik.http.routers.iobroker.service: iobroker
      traefik.http.services.iobroker.loadbalancer.server.port: {{ iobroker_ports.iobroker }}
      {% if iobroker_ports.lovelace is defined %}
      traefik.http.routers.iobroker-lovelace.entrypoints: https
      traefik.http.routers.iobroker-lovelace.rule: Host(`lovelace.{{ network.domain }}`)
      traefik.http.routers.iobroker-lovelace.service: iobroker-lovelace
      traefik.http.services.iobroker-lovelace.loadbalancer.server.port: {{ iobroker_ports.lovelace }}
      {% endif %}
      {% if iobroker_ports.lovelace_guests is defined %}
      traefik.http.routers.iobroker-lovelace-guests.entrypoints: https
      traefik.http.routers.iobroker-lovelace-guests.rule: Host(`gast.{{ network.domain }}`)
      traefik.http.routers.iobroker-lovelace-guests.service: iobroker-lovelace-guests
      traefik.http.services.iobroker-lovelace-guests.loadbalancer.server.port: {{ iobroker_ports.lovelace_guests }}
      {% endif %}
    {% if iobroker_support_wake_on_lan | default(false) | bool %}
    network_mode: host
    {% elif traefik_host %}
    networks:
      - default
      - web
    {% else %}
    ports:
      {% for service, port in iobroker_ports.items() %}
      {% if port %}
      # {{ service }}
      - "{{ port }}:{{ port }}"
      {% endif %}
      {% endfor %}
    {% endif %}
    volumes:
      - ./backups:/opt/iobroker/backups
      - iobroker-data:/opt/iobroker
      # Enable mirroring in the iobroker.javascript adapter and edit scripts via
      # SSH with e.g. VS Code.
      - ./scripts:/opt/iobroker/mirrored-scripts
    {% if iobroker_devices | length %}
    devices:
      {% for dev in iobroker_devices %}
      - {{ dev.host }}:{{ dev.container }}:rw
      {% endfor %}
    {% endif %}
    depends_on:
      redis:
        condition: service_healthy

  {% if iobroker_needs_crunchfit | default(false) | bool %}
  crunchfit:
    image: crunchfit
    pull_policy: never
    build:
      context: ./crunchfit/docker

    restart: unless-stopped
    env_file: ./crunchfit/.env
    {% if iobroker_support_wake_on_lan | default(false) | bool %}
    ports:
      - "127.0.0.1:50000:5000"
    {% endif %}
    volumes:
      - /etc/localtime:/etc/localtime
  {% endif %}
