- name: Install exporter role
  ansible.builtin.include_role:
    name: "{{ item.role }}"
  loop: "{{ node_exporter_roles }}"
  loop_control:
    label: "{{ item.role }}"

- name: Get firewalld info
  ansible.posix.firewalld_info:
  register: firewalld_info
  failed_when: false

# TODO: /etc/pve/nodes/pve-home/host.fw
- name: Allow exporter through firewall
  when: >-
    'firewalld_info' in firewalld_info
  block:
    - name: Allow exporter service through firewall
      ansible.posix.firewalld:
        service: "{{ item.firewalld_service }}"
        zone: >-
          {{
            interfaces.lan.zone |
            default(firewalld_info.firewalld_info.default_zone)
          }}
        immediate: true
        permanent: true
        state: enabled
      loop: >-
        {{
          node_exporter_roles | selectattr('firewalld_service', 'defined')
        }}
      loop_control:
        label: "firewalld_service={{ item.firewalld_service }}"

    - name: Allow exporter port through firewall
      ansible.posix.firewalld:
        port: "{{ item.port }}"
        zone: >-
          {{
            interfaces.lan.zone |
            default(firewalld_info.firewalld_info.default_zone)
          }}
        immediate: true
        permanent: true
        state: enabled
      loop: >-
        {{
          node_exporter_roles | rejectattr('firewalld_service', 'defined')
        }}
      loop_control:
        label: "port={{ item.port }}"
