- name: Generate backlog
  ansible.builtin.set_fact:
    # The select filter removes empty strings.
    tasmota_config_backlog: >-
      {{
        lookup('ansible.builtin.template', 'backlog.j2').splitlines() |
        map('trim') |
        select
      }}

- name: URL-encode backlog
  ansible.builtin.set_fact:
    tasmota_config_encoded_backlog: >-
      {{
        tasmota_config_backlog |
        join(';') |
        urlencode |
        replace('/', '%2F')
      }}

- name: Print backlog
  ansible.builtin.debug:
    msg: |
      Lines:
      {{ tasmota_config_backlog | ansible.builtin.to_nice_yaml }}
      Encoded:
      {{ tasmota_config_encoded_backlog }}

- name: Execute backlog
  delegate_to: localhost
  ansible.builtin.uri:
    url: >-
      http://{{
        hostvars[inventory_hostname].ansible_host | default(inventory_hostname)
      }}/cm?cmnd=Backlog%20{{
        tasmota_config_encoded_backlog
      }}
    return_content: true
  register: tasmota_config_backlog_result
  changed_when: true

- name: Print result
  ansible.builtin.debug:
    var: tasmota_config_backlog_result
