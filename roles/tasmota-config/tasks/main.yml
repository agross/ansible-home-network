- name: Create backlog file
  delegate_to: localhost
  ansible.builtin.tempfile:
    state: file
    suffix: backlog
  changed_when: false
  register: tasmota_config_backlog_file

- name: Generate backlog
  delegate_to: localhost
  ansible.builtin.template:
    src: templates/backlog.j2
    dest: "{{ tasmota_config_backlog_file.path }}"
    trim_blocks: true
    lstrip_blocks: true
    mode: preserve
  changed_when: false

- name: Read backlog
  ansible.builtin.set_fact:
    # The select filter removes empty strings.
    tasmota_config_backlog: >-
      {{
        lookup('ansible.builtin.file', tasmota_config_backlog_file.path).splitlines() |
        map('trim') |
        select |
        join(';') |
        urlencode |
        replace('/', '%2F')
      }}

- name: Remove backlog file
  delegate_to: localhost
  ansible.builtin.file:
    path: "{{ tasmota_config_backlog_file.path }}"
    state: absent
  changed_when: false

- name: Print backlog
  ansible.builtin.debug:
    var: tasmota_config_backlog

- name: Execute backlog
  delegate_to: localhost
  ansible.builtin.uri:
    url: >-
      http://{{
        hostvars[inventory_hostname].ansible_host | default(inventory_hostname)
      }}/cm?cmnd=Backlog%20{{ tasmota_config_backlog }}
    return_content: true
  register: tasmota_config_backlog_result
  changed_when: true

- name: Print result
  ansible.builtin.debug:
    var: tasmota_config_backlog_result
