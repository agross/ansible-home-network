#!/usr/bin/env bash
# vim: set ft=jinja-shell ts=2 sw=2 et:

set -euo pipefail

# Wait for DNS servers to be ready.

attempt=0
while ! host -p {{ ports.dnscrypt | ansible.builtin.mandatory | ansible.builtin.quote }} -4 localhost localhost; do
  >&2 printf 'dnscrypt-proxy not ready (attempt %s)\n' "$attempt"

  attempt=$((attempt + 1))
  if ((attempt > 20)); then
    >&2 printf 'Giving up\n'
    exit 1
  fi

  sleep 1
done

attempt=0
while ! resolvectl query -4 home.therightstuff.de; do
  >&2 printf 'System DNS server not ready (attempt %s)\n' "$attempt"

  attempt=$((attempt + 1))
  if ((attempt > 20)); then
    >&2 printf 'Giving up\n'
    exit 1
  fi

  sleep 1
done
