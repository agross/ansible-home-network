- name: Copy templates
  ansible.builtin.import_tasks: copy-templates.yml
  vars:
    directory: ../templates
    notify: Restart dns-server service

- name: Set SELinux file contexts
  ansible.builtin.import_tasks: systemd-unit-file-contexts.yml
  vars:
    directory: "{{ root }}/systemd"

- name: Allow execution of binaries
  community.general.sefcontext:
    target: "{{ root }}/bin/.*"
    setype: bin_t
    state: present

- name: Apply SELinux file context for binaries
  ansible.builtin.command:
    argv:
      - restorecon
      - -irv
      - "{{ root }}/bin"
  register: restorecon_result
  changed_when: restorecon_result.stdout | length > 0

- name: Copy systemd-resolved config files
  ansible.builtin.import_tasks: copy-templates.yml
  vars:
    directory: ../templates/systemd-resolved/resolved.conf.d
    target: /etc/systemd/resolved.conf.d
    notify: Restart systemd-resolved service

- name: Start systemd-resolved
  ansible.builtin.systemd:
    state: started
    enabled: true
    name: systemd-resolved
  register: systemd_resolved_started

- name: Symlink dns-server systemd unit file
  ansible.builtin.file:
    state: link
    src: "{{ root }}/systemd/dns-server.service"
    path: /etc/systemd/system/{{ service_name }}.service
    force: true
  notify: Restart dns-server service

- name: Symlink dns-server-available systemd unit file
  ansible.builtin.file:
    state: link
    src: "{{ root }}/systemd/dns-server-available.service"
    path: /etc/systemd/system/{{ service_name }}-available.service
    force: true
  notify: Restart dns-server-available service

- name: Create dnsmasq.leases unless it exists
  ansible.builtin.file:
    path: "{{ root }}/dnsmasq/dnsmasq.leases"
    state: touch
    access_time: preserve
    modification_time: preserve
    owner: 10000
    mode: '664'
  notify: Restart dns-server service

- name: Change ownership of dnscrypt-proxy directory to nobody:nogroup
  ansible.builtin.file:
    path: "{{ root }}/dnscrypt-proxy"
    owner: 65534
    group: 65533
    recurse: true
  notify: Restart dns-server service

- name: Allow DHCP and DNS-related services from internal network
  ansible.posix.firewalld:
    zone: internal
    service: "{{ item }}"
    immediate: true
    permanent: true
    state: enabled
  with_items:
    - dhcp
    - dhcpv6
    - dhcpv6-client
    - dns
    - tftp

- name: Update docker-compose images
  ansible.builtin.import_tasks: docker-compose-update.yml
  vars:
    directory: "{{ root }}"
    pull: "{{ docker_update is defined }}"
    build: "{{ docker_update is defined }}"
    notify:
      - Restart dns-server service

- name: Start dns-server service
  ansible.builtin.systemd:
    state: started
    enabled: true
    name: "{{ service_name }}"
    daemon_reload: true
  register: dns_server_started

- name: Start dns-server-available service
  ansible.builtin.systemd:
    state: started
    enabled: true
    name: "{{ service_name }}-available"
    daemon_reload: true
  register: dns_server_available_started

- name: Install DNS utils
  ansible.builtin.package:
    name: bind-utils
    state: present
