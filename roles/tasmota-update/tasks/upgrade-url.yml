- name: Get current OTA URL
  delegate_to: localhost
  ansible.builtin.uri:
    url: >-
      http://{{
        hostvars[inventory_hostname].ansible_host | default(inventory_hostname)
      }}/cm?cmnd=OtaUrl{{ tasmota_credentials | default('') }}
    return_content: true
  register: tasmota_update_original_ota_url
  changed_when: false

- name: Determine OTA URL for variant
  ansible.builtin.set_fact:
    tasmota_update_ota_url: >-
      {{
        tasmota_update_ota_release[tasmota_update_tasmota_variant]
      }}
  failed_when: not tasmota_update_ota_url is url

- name: Set upgrade URL
  when: tasmota_update_original_ota_url.json.OtaUrl != tasmota_update_ota_url
  delegate_to: localhost
  ansible.builtin.uri:
    url: >-
      http://{{
        hostvars[inventory_hostname].ansible_host | default(inventory_hostname)
      }}/cm?cmnd=OtaUrl%20{{
        tasmota_update_ota_url
      }}{{
        tasmota_credentials | default('')
      }}

- name: Show upgrade URL
  ansible.builtin.debug:
    msg: >-
      OTA URL {{
        tasmota_update_ota_url
      }}{% if tasmota_update_original_ota_url.json.OtaUrl != tasmota_update_ota_url %}
      (changed from {{
        tasmota_update_original_ota_url.json.OtaUrl
      }}){% endif %}
  changed_when: false
