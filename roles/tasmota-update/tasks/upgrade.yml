- name: Show firmware version
  ansible.builtin.debug:
    msg: >-
      Upgrading from {{
        tasmota_update_current_firmware.json.StatusFWR.Version
      }}
      ({{
        tasmota_update_current_firmware_version
      }}) to {{
        tasmota_update_version
      }}
  changed_when: false

- name: Upgrade
  delegate_to: localhost
  ansible.builtin.uri:
    url: >-
      http://{{
        hostvars[inventory_hostname].ansible_host | default(inventory_hostname)
      }}/cm?cmnd=Upgrade%201{{ tasmota_credentials | default('') }}
    return_content: true
  register: status

- name: Wait for reboot
  delegate_to: localhost
  ansible.builtin.wait_for:
    host: >-
      {{
        hostvars[inventory_hostname].ansible_host | default(inventory_hostname)
      }}
    port: 80
    # Less delay may report old version.
    delay: 60

- name: Get new firmware version
  delegate_to: localhost
  ansible.builtin.uri:
    url: >-
      http://{{
        hostvars[inventory_hostname].ansible_host | default(inventory_hostname)
      }}/cm?cmnd=Status%202{{ tasmota_credentials | default('') }}
    return_content: true
  changed_when: false
  register: tasmota_update_new_firmware

- name: Show new firmware version
  ansible.builtin.debug:
    msg: >-
      Upgraded from {{
        tasmota_update_current_firmware.json.StatusFWR.Version
      }} to {{
        tasmota_update_new_firmware.json.StatusFWR.Version
      }}
  changed_when: >-
    tasmota_update_current_firmware.json.StatusFWR.Version
    is version(tasmota_update_new_firmware.json.StatusFWR.Version, '!=')
