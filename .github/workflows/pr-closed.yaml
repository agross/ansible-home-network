name: PR closed

on:
  pull_request:
    types:
      - closed

jobs:
  affected-roles:
    name: Determine roles affected by the PR
    runs-on: ubuntu-latest

    if: |
      github.event.pull_request.merged == true &&
      !contains(github.event.pull_request.labels.*.name, 'skip-ansible')

    outputs:
      roles: ${{ steps.affected-roles.outputs.roles }}

    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"

      - name: Get latest code
        uses: actions/checkout@v5

      - name: Download base commit and merge commit
        run: |
          git fetch \
              origin \
              ${{ github.event.pull_request.base.sha }} \
              ${{ github.event.pull_request.merge_commit_sha }}

      - name: Show affected files
        run: |
          git diff \
              --name-status \
              ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.merge_commit_sha }}

      - name: Determine roles from affected files
        id: affected-roles
        run: |
          {
            echo 'roles<<ROLES'

            git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.merge_commit_sha }} -- host_vars group_vars roles |
            sed -e 's|.*_vars/.*/\([^.]*\).*|\1|' -e 's|roles/\([^/]*\)/.*|\1|' |
            sort |
            uniq |
            paste --serial --delimiter=,

            echo ROLES
          } >> "$GITHUB_OUTPUT"

      - name: Show roles
        env:
          ROLES: ${{ steps.affected-roles.outputs.roles }}
        run: |
          printf 'Roles affected by the merge: %s\n' "$ROLES"

  run-ansible:
    name: Run Ansible with tags ${{ needs.affected-roles.outputs.roles }}

    needs: affected-roles

    if: needs.affected-roles.outputs.roles != ''

    uses: ./.github/workflows/ansible.yaml
    with:
      tags: ${{ needs.affected-roles.outputs.roles }}
    secrets: inherit
