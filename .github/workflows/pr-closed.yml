name: PR Closed

on:
  pull_request:
    types:
      - closed

jobs:
  testing:
    name: Test what happens when closing a PR
    runs-on: ubuntu-latest

    steps:
      - name: Show env vars
        run: env

      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"

  if_merged:
    name: Test what happens when closing a PR by accepting it
    runs-on: ubuntu-latest

    if: github.event.pull_request.merged == true

    steps:
      - run: |
          echo The PR was merged

  affected-files-and-roles:
    name: Show affected files and roles
    runs-on: ubuntu-latest

    if: github.event.pull_request.merged == true

    steps:
      - name: Get latest code
        uses: actions/checkout@v5

      - name: Download base commit and merge commit
        run: |
          git fetch \
              origin \
              ${{ github.event.pull_request.base.sha }} \
              ${{ github.event.pull_request.merge_commit_sha }}

      - name: Show affected files
        run: |
          git diff \
              --name-status \
              ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.merge_commit_sha }}

      - name: Determine roles from affected files
        id: affected-roles
        run: |
          {
            echo 'roles<<ROLES'

            git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.merge_commit_sha }} |
            grep '^roles' |
            sed -e 's|roles/\([^/]*\)/.*|\1|' |
            sort |
            uniq |
            paste --serial --delimiter=,

            echo ROLES
          } >> "$GITHUB_ENV"

      - name: Show roles
        env:
          ROLES: ${{ steps.affected-roles.outputs.roles }}
        run: >-
          printf 'Roles affected by the merge: %s\n' "$ROLES"
