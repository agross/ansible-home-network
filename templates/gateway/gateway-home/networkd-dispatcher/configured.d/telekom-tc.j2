#!/usr/bin/env bash
# vim: set ft=jinja-shell ts=2 sw=2 et:

# Log outputs with:
#
# journalctl --follow --unit networkd-dispatcher.service

set -euo pipefail
shopt -s inherit_errexit

[[ "${IFACE:-}" == {{ interfaces.telekom.device | mandatory | quote }} ]] || exit  0

# Redirect traffic incoming on $IFACE to $IFACE-ingress to shape it there.
# https://www.bufferbloat.net/projects/codel/wiki/CakeRecipes/
if [[ -z "$(tc filter show dev "$IFACE" ingress)" ]]; then
  printf 'Redirecting incoming traffic from %s to %s\n' "$IFACE" "$IFACE-ingress"
  tc filter add dev "$IFACE" \
            parent ffff: basic \
            action mirred egress redirect \
            dev "$IFACE-ingress"
fi
